<?php

class CerBulkUpdate extends DrupalWebTestCase {

  public static function getInfo() {
    return [
      'name' =>
        'Bulk Update',
      'group' =>
        'CER',
      'description' =>
        'Tests CER bulk update.',
    ];
  }

  public function setUp() {
    parent::setUp('ctools', 'entity', 'entityreference', 'cer');

    field_create_field([
      'type' =>
        'entityreference',
      'field_name' =>
        'field_ref',
      'cardinality' =>
        1,
      'settings' => [
        'target_type' => 'node',
      ],
    ]);

    field_create_instance([
      'entity_type' =>
        'node',
      'bundle' =>
        'page',
      'field_name' =>
        'field_ref',
    ]);

    field_create_instance([
      'entity_type' =>
        'node',
      'bundle' =>
        'article',
      'field_name' =>
        'field_ref',
    ]);
  }

  public function test() {
    // Create 100 nodes, 50 of each type.
    $a = $b = [];
    for ($i = 0; $i < 50; $i++) {
      $a[] = $this->drupalCreateNode(['type' => 'page'])->nid;
      $b[] = $this->drupalCreateNode(['type' => 'article'])->nid;
    }
    
    // Create a map of which right nodes should be referenced by the left nodes.
    $map = [];
    for ($i = 0; $i < 50; $i++) {
      shuffle($b);
      $map[ $a[$i] ] = $b[0];
      array_shift($b);
    }

    foreach ($map as $nid => $ref) {
      $node = new EntityDrupalWrapper('node', node_load($nid));
      $node->field_ref->set( node_load($ref) );
      $node->save();
    }

    $left = new CerFieldChain();
    $left->addField(new CerEntityReferenceField('node', 'page', 'field_ref'));

    $right = new CerFieldChain();
    $right->addField(new CerEntityReferenceField('node', 'article', 'field_ref'));

    $preset = new CerPreset();
    $preset->left($left);
    $preset->right($right);
    $preset->write();
    
    // As far as I can tell, SimpleTest doesn't really support testing batch operations.
    // This, therefore, is the core of what the bulk update does. If I'm wrong about
    // SimpleTest not supporting batch operation testing, PLEASE submit a patch to
    // CER with better test code! Or at least tell me what I'm missing!
    $IDs = array_merge(array_keys($map), array_values($map));
    foreach ($IDs as $nid) {
      cer_processing_entity('bulk_update', $nid, 'node');
    }

    // Ensure that the updated nodes match the map we created.
    $verified = 0;
    foreach ($map as $ref => $nid) {
      $node = new EntityDrupalWrapper('node', node_load($nid));

      if ($node->field_ref->getIdentifier() == $ref) {
        $verified++;
      }
    }
    $this->assertEqual($verified, sizeof($a), 'Bulk updated 100 nodes.');
  }

}
